<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hot Tub Odoo Invoice Machine</title>
    <script type="module"
        src="https://cdn.jsdelivr.net/npm/@myriaddreamin/typst.ts/dist/esm/contrib/all-in-one-lite.bundle.js"
        id="typst"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
        integrity="sha512-dfX5uYVXzyU8+KHqj8bjo7UkOdg18PaOtpa48djpNbZHwExddghZ+ZmzWT06R5v6NSk3ZUfsH6FNEDepLx9hPQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <main class="container-fluid">
        <header>
            <h1>Hot Tub Odoo Invoice Machine</h1>
        </header>
        <div style="display: flex; flex-direction: row; gap: 20px">
            <form id="form" style="flex: 1; max-width: 50%">
                <div style="
              display: flex;
              flex-direction: column;
              gap: 10px;
              padding: 16px;
            ">
                    <h3>Your Details</h3>
                    <input type="text" name="author_name" placeholder="Your name" />
                    <input type="text" name="your_address" placeholder="Your Street Address" />
                    <input type="text" name="your_city_state_postcode"
                        placeholder="Your City, Your State, Your Postcode" />
                    <input type="email" name="your_email" placeholder="Your Email Address" />
                    <input type="tel" name="your_phone" placeholder="Your Phone Number" />
                    <input type="text" name="abn" placeholder="ABN" />

                    <h3>Invoice Details</h3>
                    <div style="display: flex; flex-direction: row; gap: 10px;">
                        <div>
                            <label for="period_start">Billing Period Start</label>
                            <input type="date" name="period_start" />
                        </div>
                        <div>
                            <label for="period_end">Billing Period End</label>
                            <input type="date" name="period_end" />
                        </div>

                    </div>
                    <input type="number" name="hourly_rate" placeholder="Hourly Rate ($)" />


                    <h3>Recipient Details</h3>
                    <input type="text" name="client_name" placeholder="Client Name" />
                    <input type="text" name="client_address" placeholder="Client Street Address" />

                    <h3>Payment Details</h3>
                    <input type="text" name="bank_name" placeholder="Bank Name" />
                    <input type="text" name="account_name" placeholder="Account Name" />
                    <input type="text" name="bsb" placeholder="BSB" />
                    <input type="text" name="account_number" placeholder="Account Number" />

                    <h3>Invoice Items (Upload CSV)</h3>
                    <input type="file" id="csv-upload" name="csv_file" accept=".csv" />

                    <button id="export" type="submit">
                        Generate and Export to PDF
                    </button>
                </div>
            </form>
            <div style="
            flex: 1;
            max-width: 50%;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 10px;
          ">
                <h3 style="text-align: center">Live Preview</h3>
                <div id="content" style="background-color: white; padding: 20px"></div>
            </div>
        </div>
    </main>

    <script>
        const contentDiv = document.getElementById("content");
        const form = document.getElementById("form");
        const csvFile = document.getElementById("csv-upload");

        const baseTypstTemplate = `
#let invoice_number = "$invoice_number_placeholder$"
#let author_name = "$author_name_placeholder$"
#let your_address = "$your_address_placeholder$"
#let your_city_state_postcode = "$your_city_state_postcode_placeholder$"
#let your_email = "$your_email_placeholder$"
#let your_phone = "$your_phone_placeholder$"
#let date_of_issuance = "$date_of_issuance_placeholder$"
#let period_covered = "$period_covered_placeholder$"
#let abn = "$abn_placeholder$"
#let client_name = "$client_name_placeholder$"
#let client_address = "$client_address_placeholder$"
#let bank_name = "$bank_name_placeholder$"
#let account_name = "$account_name_placeholder$"
#let bsb = "$bsb_placeholder$"
#let account_number = "$account_number_placeholder$"

#let invoice_items = ($invoice_items_placeholder$)
#let total = "$total_placeholder$"
#let gst = "$gst_placeholder$"
#set document(title: "Invoice")
#set text(font: "Helvetica", size: 11pt)

#align(right)[
    #text(16pt, weight: "bold")[TAX INVOICE] \\
    #date_of_issuance
    ]
    #line(length: 100%, stroke: black.darken(10%))
    
    
#v(1em)
#columns(2, gutter: 1em)[
  #block[
    #text(weight: "bold")[From:] \\
    #author_name \\
    #your_address \\
    #your_city_state_postcode \\
    ABN: #(abn) \\
    #your_email \\
    #your_phone \\
  ]
  
  #block[
    #text(weight: "bold")[To:] \\
    #client_name \\
    #client_address \\
    ]
]
#v(1em)
#line(length: 100%, stroke: black.darken(10%))
#v(1em)

#columns(1, gutter: 1em)[
    #block[#text(weight: "bold")[Invoice Period:] #period_covered]
    ]
    
    
    #v(1em)
    #table(
        columns: (auto, auto, auto, auto, auto, auto),
        align: (left, left, left, left, right, right),
        inset: 5pt,
        [#text(weight: "bold")[Date]],
        [#text(weight: "bold")[Project]],
        [#text(weight: "bold")[Task]],
        [#text(weight: "bold")[Description]],
        [#text(weight: "bold")[Quantity]],
        [#text(weight: "bold")[Hourly Rate]],
        ..invoice_items.map(item => (
            [#text(10pt)[#(item.date)]],
            [#text(10pt)[#(item.project)]],
            [#text(10pt)[#(item.task)]],
            [#text(10pt)[#(item.description)]],
            [#text(10pt)[#(item.quantity)]],
            [#text(10pt)[#(item.hourly_rate)]],
            )).flatten(),
            )
            
            
            #align(right, [
                #v(1em)
                #table(
                    columns: (2),  
                    [#text(weight: "bold")[GST]], [#text()[\\$#(gst)]],
                    [#text(weight: "bold")[Total]], [#text()[\\$#(total)]],
                    )
                    ]) 
                    
                    
                    #v(1em)
                    #line(length: 100%, stroke: black.darken(10%))
                    #v(1em)
                    
                    #text(12pt, weight: "bold")[Remit to:] \\
                    #text(10pt)[Bank Name: #bank_name] \\
                    #text(10pt)[Account Name: #account_name] \\
                    #text(10pt)[BSB: #bsb] \\
                    #text(10pt)[Account Number: #account_number] \\
                    #text(10pt)[Payment terms:] 14 days
                    `;

        // Exports SVG and puts it into the `contentDiv`
        const previewSvg = (mainContent) => {
            $typst
                .svg({ mainContent })
                .then((svg) => {
                    contentDiv.innerHTML = svg;
                    const svgElem = contentDiv.firstElementChild;
                    if (!svgElem) return;

                    const width = Number.parseFloat(svgElem.getAttribute("width"));
                    const height = Number.parseFloat(svgElem.getAttribute("height"));
                    const cw = contentDiv.clientWidth;
                    svgElem.setAttribute("width", cw);
                    svgElem.setAttribute("height", (height * cw) / width);
                })
                .catch((e) => {
                    console.error(e);
                    contentDiv.innerHTML = `<p style="color: red;">Error generating preview: ${e.message}</p>`;
                });
        };


        const exportPdf = (mainContent) => {
            $typst
                .pdf({ mainContent })
                .then((pdfData) => {
                    var pdfFile = new Blob([pdfData], { type: "application/pdf" });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(pdfFile);
                    link.download = "invoice.pdf";
                    link.target = "_blank";
                    link.click();
                })
                .catch((e) => {
                    alert(`Error exporting PDF: ${e.message}`);
                });
        };

        const parseCSV = (file) => {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                        resolve(results.data);
                    },
                    error: function (err) {
                        reject(new Error(`Error parsing CSV: ${err}`));
                    },
                });
            });
        };

        const generateTypstFromData = async (formData) => {
            let typstString = baseTypstTemplate;
            let total = 0;
            const hourlyRate = Number(formData.hourly_rate) ?? 0.0

            const file = csvFile.files?.[0] ?? null;
            const invoiceItems = file ? await parseCSV(file) : [];

            const invoiceItemsTypst = invoiceItems
                .sort((a, b) => new Date(a.Date) - new Date(b.Date))
                .map((item) => {
                    const itemTotal = item.Quantity * hourlyRate; // Use hourlyRate from form
                    total += itemTotal;
                    // Note: Typst needs backslashes to be escaped for strings
                    const description = item.Description.replaceAll('"', '\\"');
                    return `(date: "${item.Date}", project: "${item.Project}", task: "${item.Task}", description: "${description}", quantity: ${item.Quantity}, hourly_rate: ${hourlyRate.toFixed(2)})`;
                })
                .join(",\n  ");


            // No GST here
            const gst = total * 0.0;
            const periodCovered = `${formData?.period_start ?? '[Start Date]'} - ${formData?.period_end ?? '[End Date]'}`;

            typstString = typstString.replace(
                "$invoice_items_placeholder$",
                invoiceItemsTypst || ""
            );
            typstString = typstString.replace("$author_name_placeholder$", formData.author_name || "");
            typstString = typstString.replace("$your_address_placeholder$", formData.your_address || "Your Street Address");
            typstString = typstString.replace("$your_city_state_postcode_placeholder$", formData.your_city_state_postcode || "Your City, Your State, Your Postcode");
            typstString = typstString.replace("$your_email_placeholder$", formData.your_email || "Your Email Address");
            typstString = typstString.replace("$your_phone_placeholder$", formData.your_phone || "Your Phone Number");
            typstString = typstString.replace("$total_placeholder$", total.toFixed(2));
            typstString = typstString.replace("$gst_placeholder$", gst.toFixed(2));
            typstString = typstString.replace("$date_of_issuance_placeholder$", new Date().toISOString().slice(0, 10));
            typstString = typstString.replace("$period_covered_placeholder$", periodCovered);
            typstString = typstString.replace("$abn_placeholder$", formData?.abn || "[ABN]");
            typstString = typstString.replace("$client_name_placeholder$", formData?.client_name || "[Client Name]");
            typstString = typstString.replace("$client_address_placeholder$", formData?.client_address || "[Client Address]");
            typstString = typstString.replace("$bank_name_placeholder$", formData?.bank_name || "[Bank Name]");
            typstString = typstString.replace("$account_name_placeholder$", formData?.account_name || "[Account Name]");
            typstString = typstString.replace("$bsb_placeholder$", formData?.bsb ?? "[BSB]");
            typstString = typstString.replace("$account_number_placeholder$", formData?.account_number ?? "[Account Number]");

            // This is new - invoice number and period covered are not provided, so I'll create a placeholder for it
            typstString = typstString.replace('$invoice_number_placeholder$', '[Invoice Number]');

            return typstString;
        };

        const processForm = async (e, action) => {
            e.preventDefault();
            const formData = Object.fromEntries(new FormData(e.target));
            const finalTypstCode = await generateTypstFromData(formData);
            if (action === 'export') {
                exportPdf(finalTypstCode);
            } else {
                previewSvg(finalTypstCode);
            }
        };

        const previewInvoice = async () => {
            const formData = Object.fromEntries(new FormData(form));
            const finalTypstCode = await generateTypstFromData(formData);
            previewSvg(finalTypstCode);
        };

        const saveFormState = () => {
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                if (key !== 'csv_file') {
                    data[key] = value;
                }
            }
            localStorage.setItem('invoiceFormState', JSON.stringify(data));
        };

        const loadFormState = () => {
            const savedState = localStorage.getItem('invoiceFormState');
            if (savedState) {
                const data = JSON.parse(savedState);
                for (const key in data) {
                    const input = form.elements.namedItem(key);
                    if (input) {
                        input.value = data[key];
                    }
                }
            }
        };

        form.addEventListener("submit", (e) => processForm(e, "export"));
        form.addEventListener("change", (e) => {
            if (e.target.type !== "submit") {
                previewInvoice();
                saveFormState();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadFormState();
        });


        document
            .getElementById("typst")
            .addEventListener("load", async function () {
                $typst.setCompilerInitOptions({
                    getModule: () =>
                        "https://cdn.jsdelivr.net/npm/@myriaddreamin/typst-ts-web-compiler/pkg/typst_ts_web_compiler_bg.wasm",
                });
                $typst.setRendererInitOptions({
                    getModule: () =>
                        "https://cdn.jsdelivr.net/npm/@myriaddreamin/typst-ts-renderer/pkg/typst_ts_renderer_bg.wasm",
                });

                previewInvoice();
            });
    </script>
</body>

</html>